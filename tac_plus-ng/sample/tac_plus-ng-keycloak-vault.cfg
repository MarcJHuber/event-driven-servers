# tac_plus-ng sample configuration — Keycloak + Vault failover chain
#
# Chain: Keycloak (primary) → Vault (break-glass fallback)
#
# Keycloak handles normal user authentication via ROPC. If Keycloak is down
# (ERROR) or the user doesn't exist there (NOTFOUND), the request falls
# through to the Vault backend, which reads static credentials from
# HashiCorp Vault KV v2.
#
# MAVIS chain mechanics (see mavis_glue.c:99-121):
#   - "action notfound = continue" is the DEFAULT — a NOTFOUND result becomes
#     MAVIS_DOWN, passing the request to the next module in the chain.
#   - "action error = continue" must be set EXPLICITLY on Keycloak so that
#     connection errors (Keycloak down) also fall through to Vault.
#   - The last module in the chain (Vault) returns final verdicts — its
#     FAIL/ERROR results are terminal.
#
# NOTE on setenv and execve:
#   libmavis_external.c (line ~701-704) uses execve() when ANY "setenv" is
#   present, which replaces the entire process environment. The child process
#   gets ONLY the explicitly listed setenv vars — no PATH, PYTHONPATH,
#   LD_LIBRARY_PATH, etc. Even a single setenv triggers this.
#
#   For containerized deployments, the simplest approach is to use ZERO setenv
#   directives and instead pass ALL variables via Docker env_file or -e flags.
#   With no setenv, the child inherits the full container environment
#   (including PYTHONPATH set in the Dockerfile), and the scripts read their
#   config via os.getenv() either way.
#
#   If you must use setenv (e.g. bare-metal, no container), you need to list
#   every variable the child needs — including PATH and PYTHONPATH.
#
# Keycloak prerequisites:
#   1. Create a client with "Direct Access Grants" (ROPC) enabled
#   2. Add a "Group Membership" protocol mapper to include groups in the token:
#      Client > Client scopes > dedicated scope > Add mapper > By type >
#      "Group Membership" — set Token Claim Name to "groups", Full group path OFF
#   3. Create groups in Keycloak matching the group names below
#
# Vault prerequisites:
#   1. Enable KV v2 at the configured mount point (default: secret/)
#   2. Create an AppRole with read access to the user secrets path
#   3. Store user secrets:
#      vault kv put secret/tacacs/users/admin password=s3cret groups=admin,noc
#      vault kv put secret/tacacs/users/breakglass password=emergency groups=admin
#
# Docker usage:
#   docker run \
#     -v $PWD/tac_plus-ng-keycloak-vault.cfg:/etc/tac_plus-ng/tac_plus-ng.cfg \
#     --env-file tacplus.env \
#     -p 49:49 ghcr.io/marcinpsk/tacplus-ng

id = spawnd {
	listen { port = 49 }
	spawn {
		instances min = 1
		instances max = 10
	}
}

id = tac_plus-ng {

	# Keycloak MAVIS backend (primary) #####################################
	mavis module keycloak = external {
		exec = /usr/local/lib/mavis/mavis_tacplus_keycloak.py
		# Required: KEYCLOAK_URL (script will refuse to start without it)
		# setenv KEYCLOAK_URL = https://keycloak.example.com
		# setenv KEYCLOAK_REALM = myrealm
		# setenv KEYCLOAK_CLIENT_ID = tacacs
		# setenv KEYCLOAK_CLIENT_SECRET = changeme
		# setenv KEYCLOAK_VERIFY_TLS = 1
		# setenv KEYCLOAK_REQUIRE_GROUP = tacacs-users

		# Fall through to Vault on Keycloak errors (server down, timeout)
		action error = continue
	}

	# Vault MAVIS backend (break-glass fallback) ############################
	mavis module vault = external {
		exec = /usr/local/lib/mavis/mavis_tacplus_vault.py
		# Required: VAULT_ADDR, VAULT_ROLE_ID, VAULT_SECRET_ID
		# setenv VAULT_ADDR = https://vault.example.com:8200
		# setenv VAULT_ROLE_ID = <role-id>
		# setenv VAULT_SECRET_ID = <secret-id>
		# setenv VAULT_MOUNT = secret
		# setenv VAULT_PATH_PREFIX = tacacs/users
		# setenv VAULT_VERIFY_TLS = 1
		# setenv VAULT_CACHE_TTL = 300
		# setenv VAULT_REDIS_CACHE_TTL = 600
	}

	user backend = mavis
	login backend = mavis
	pap backend = mavis

	# Devices ###############################################################
	host world {
		address = 0.0.0.0/0
		address = ::/0
		# key = changeme
		enable 15 = login
	}

	# Profiles ##############################################################
	profile admin {
		script {
			if (service == shell) {
			    if (cmd == "")
				set priv-lvl = 15
			    permit
			}
		}
	}

	profile engineering {
		enable 15 = login
		script {
			if (service == shell) {
			    if (cmd == "")
				set priv-lvl = 15
			    permit
			}
		}
	}

	profile readonly {
		script {
			if (service == shell) {
			    if (cmd == "") {
				set priv-lvl = 1
				permit
			    }
			    if (cmd =~ /^show/) permit
			    deny
			}
		}
	}

	# Groups (matched by Keycloak/Vault group membership) ##################
	group admin { }
	group engineering { }
	group readonly { }
	group noc { }

	# Ruleset ###############################################################
	ruleset {
		rule default {
			enabled = yes
			script {
				if (member == admin) {
					profile = admin
					permit
				}
				if (member == engineering) {
					profile = engineering
					permit
				}
				if (member == readonly) {
					profile = readonly
					permit
				}
				# Deny users not matching any known group
				deny
			}
		}
	}
}
