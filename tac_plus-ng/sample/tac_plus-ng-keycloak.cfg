# tac_plus-ng sample configuration with Keycloak authentication
#
# Keycloak prerequisites:
#   1. Create a client with "Direct Access Grants" (ROPC) enabled
#   2. Add a "Group Membership" protocol mapper to include groups in the token:
#      Client > Client scopes > dedicated scope > Add mapper > By type >
#      "Group Membership" â€” set Token Claim Name to "groups", Full group path OFF
#   3. Create groups in Keycloak matching the group names below (e.g. "admin",
#      "engineering", "readonly")
#
# Docker usage:
#   docker run -v $PWD/tac_plus-ng-keycloak.cfg:/etc/tac_plus-ng/tac_plus-ng.cfg \
#     -p 49:49 ghcr.io/marcinpsk/tacplus-ng

id = spawnd {
	listen { port = 49 }
	spawn {
		instances min = 1
		instances max = 10
	}
}

id = tac_plus-ng {

	# Keycloak MAVIS backend ################################################
	mavis module keycloak = external {
		exec = /usr/local/lib/mavis/mavis_tacplus_keycloak.py
		# setenv KEYCLOAK_URL = https://keycloak.example.com
		# setenv KEYCLOAK_REALM = myrealm
		# setenv KEYCLOAK_CLIENT_ID = tacacs
		# setenv KEYCLOAK_CLIENT_SECRET = changeme
		# setenv KEYCLOAK_VERIFY_TLS = 1
		# setenv KEYCLOAK_REQUIRE_GROUP = tacacs-users
	}

	user backend = mavis
	login backend = mavis
	pap backend = mavis

	# Devices ###############################################################
	host world {
		address = 0.0.0.0/0
		address = ::/0
		# key = changeme
		enable 15 = login
	}

	# Profiles ##############################################################
	profile admin {
		script {
			if (service == shell) {
			    if (cmd == "")
				set priv-lvl = 15
			    permit
			}
		}
	}

	profile engineering {
		enable 15 = login
		script {
			if (service == shell) {
			    if (cmd == "")
				set priv-lvl = 15
			    permit
			}
		}
	}

	profile readonly {
		script {
			if (service == shell) {
			    if (cmd == "") {
				set priv-lvl = 1
				permit
			    }
			    if (cmd =~ /^show/) permit
			    deny
			}
		}
	}

	# Groups (matched by Keycloak group membership) #########################
	group admin { }
	group engineering { }
	group readonly { }

	# Ruleset ###############################################################
	ruleset {
		rule default {
			enabled = yes
			script {
				if (member == admin) {
					profile = admin
					permit
				}
				if (member == engineering) {
					profile = engineering
					permit
				}
				if (member == readonly) {
					profile = readonly
					permit
				}
			}
		}
	}
}
